# Doppler-based Sky Map from Rotating Earth Transmitters

A self-contained **toy model** that reconstructs a simple sky map from time–frequency patterns generated by Earth-fixed radio transmitters observed from a distant line of sight. The code exports **all plots to a single multi-page PDF**.

> **Scope.** This is a research toy model for demonstration and teaching. It is not intended to model real transmitter networks with high fidelity.

---

## Highlights

- Computes line-of-sight Doppler shifts for cities on a rotating Earth
- Builds a time–frequency spectrogram \(P(t,f)\) and applies frequency smoothing + time-axis FFT
- Integrates against associated Legendre functions to obtain coefficients \(a_{\mathrm{sh}}\)
- Reconstructs clean and noisy sky maps
- **Single output**: `reconstruct.pdf` containing every figure (no EPS output)

---

## Repository layout

```
.
├─ reconstruct.py        # main script (logic kept exactly as authored)
├─ requirements.txt      # runtime dependencies
├─ LICENSE               # e.g., MIT (edit as needed)
├─ README.md             # this file
└─ data/
   └─ city_10.csv        # input catalog (you provide)
```

> The script expects `data/city_10.csv` by default. You can use a different path if you edit the `pd.read_csv(...)` line in `reconstruct.py`.

---

## Requirements

- Python **3.10+**
- Packages: `numpy`, `pandas`, `matplotlib`, `scipy`, `cartopy`, `certifi`
- Cartopy may require system libraries (GEOS/Shapely/PROJ) depending on your platform

Install everything with:

```bash
python -m venv .venv
source .venv/bin/activate         # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

Conda users:

```bash
conda create -n doppler-sky python=3.11
conda activate doppler-sky
pip install -r requirements.txt
```

---

## Input data

The script reads a CSV file with columns:

- `Latitude`  (degrees, north positive)
- `Longitude` (degrees, east positive)
- `Population` (integer or float; used as a weight)

Minimal example:

```csv
Latitude,Longitude,Population
35.6895,139.6917,13960000
34.0522,-118.2437,3980000
```

Place your file at `data/city_10.csv`.

---

## Usage

From the repository root:

```bash
python reconstruct.py
```

This produces `reconstruct.pdf` in the project root that includes:

1. City distribution map
2. Spectrograms (clean/noisy; linear/log)
3. FFT panels of the time-axis transform
4. Average power vs. spherical-harmonic degree \(l\)
5. Reconstructed sky maps (clean and noisy), with coastlines

> The script prints basic progress info to stdout and may take a few minutes depending on `l_max`, `num_times`, and `num_freq`.

---

## Parameters (defined at the top of `reconstruct.py`)

| Name            | Default | Meaning |
|-----------------|---------|---------|
| `theta_deg`     | `0`     | Rotation-axis colatitude in degrees |
| `phi_deg`       | `0`     | Rotation-axis longitude in degrees  |
| `width`         | `0.05`  | Limb selection half-width (radians) |
| `smooth`        | `1`     | Gaussian smoothing sigma along frequency axis |
| `noise`         | `5`     | Std. dev. of additive Gaussian noise in spectrogram |
| `l_max`         | `20`    | Max spherical-harmonic degree for reconstruction |
| `days`          | `1`     | Duration in sidereal days |
| `observer_dir`  | `[1,0,0]` | Observer LOS unit vector |
| `chunk_size`    | `300`   | Cities per processing chunk |
| `num_freq`      | `1200`  | Frequency bins in spectrogram |
| `num_times`     | `1200*days` | Time samples |
| Physical consts | fixed   | Earth radius, sidereal rate, speed of light |

> **Note:** Please keep the logic unchanged if you intend to reproduce the original results or compare commits.

---

## Output

- **File:** `reconstruct.pdf`  
  Contains all figures in order. The spectrograms are shown both in linear and log scales, followed by FFT summaries and two map reconstructions (clean / noisy) over a Cartopy Plate Carrée projection with coastlines and labeled axes.

- **Stochasticity:** The noisy case adds Gaussian noise; numerical values and minor visual details will vary between runs.

---

## Dependency notes

### Cartopy & SSL
The script sets:
```python
os.environ["SSL_CERT_FILE"] = certifi.where()
```
to help Cartopy fetch Natural Earth assets over HTTPS on stricter environments. Ensure `certifi` is installed (it’s in `requirements.txt`) and the machine has internet access the first time tiles are requested.

### SciPy spherical harmonics API
The script uses:
```python
from scipy.special import sph_harm_y
```
to mirror an original API variant. If your SciPy provides only
```python
scipy.special.sph_harm(m, l, theta, phi)
```
adapt the import **locally** and keep the math identical. The repository preserves the original call for fidelity.

---

## Performance tips

- Reduce `l_max`, `num_times`, or `num_freq` for quicker runs.
- Lower `chunk_size` if you encounter memory pressure with large city catalogs.
- Run with an optimized BLAS if available (e.g., via conda).

---

## Troubleshooting

- **Cartopy fails to draw coastlines / SSL error**
  - Verify `certifi` is installed.
  - Re-install `cartopy` and ensure GEOS/Shapely are present.
  - Try running once with an active internet connection so Cartopy can cache resources.

- **`sph_harm_y` not found**
  - Use `sph_harm(m, l, theta, phi)` instead in your local copy, preserving argument order and conjugation logic in `compute_map_chunk`.

- **PDF is empty or missing**
  - Ensure the script completes without exceptions.
  - Check write permissions in the working directory.

---

## Reproducibility

- The noisy path uses random draws (no fixed seed). If you need bit-level reproducibility, set a NumPy RNG seed at the top of the script in your local environment:
  ```python
  np.random.seed(0)
  ```
  (This is not included by default to keep the original behavior unchanged.)

---

## Known limitations

- City populations are used as simple weights; this is **not** a realistic model of transmitter power or spectrum usage.
- The limb selection is geometrical and narrow-beam; atmospheric/ionospheric effects are ignored.
- Coordinate conventions in the map reconstruction follow the original code’s `alpha, delta` grids and transformations; they are internally consistent with the figures produced.

---

## Contributing

Issues and pull requests are welcome for:
- Documentation clarifications
- Environment fixes (Cartopy tips across platforms)
- Optional utilities (data loaders, sampling scripts)

> Please **do not** propose logic changes to `reconstruct.py` unless clearly marked as optional or placed behind flags; the main script intentionally mirrors the original behavior.

---

## License

This project is released under the **MIT License** (see `LICENSE`).  
© 2025 Keitaro Takahashi

---

## Citation

If you use this repository in academic work, please cite it with the repository URL and commit hash, for example:

```
Takahashi, K. (2025). Doppler-based Sky Map from Rotating Earth Transmitters (Version <commit>).
GitHub repository: <URL>
```

You may also add a `CITATION.cff` to the repository if you prefer.

---

## Acknowledgments

- Natural Earth data via Cartopy for coastlines.
- NumPy, SciPy, Matplotlib, Pandas, and Cartopy communities for the core scientific Python stack.
